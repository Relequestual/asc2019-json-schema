import { swiss } from 'mdx-deck/themes';
import myTheme from './myTheme';

import {
  CodeSurferLayout,
  CodeSurferColumnLayout,
  Code,
  Step,
  github,
} from "code-surfer";
import ContentLayout from './layouts/content';
import { Notes, Invert, Appear, Split } from "mdx-deck";

import basicSchemas from "./schemas/basic";

import mmev1 from "./static/mme-v1.png";
import drafts from "./static/drafts.png";

export const themes = [swiss, myTheme, github];

# JSON Schema

### Core Concepts, Common Pitfalls, and Debugging

<p>
  üßî Ben Hutton<br/>
  üíº JSON Schema core<br/>
  üôå <a href="https://opencollective.com/json-schema">opencollective.com/json-schema</a><br/>
  üé§ ASC 2019 - API Specification Conference 2019
</p>

<Notes>
  Some content
</Notes>

---

<Invert>

# Validation saves lives

</Invert>

---
# Validation (probably?) saves lives

---
# Validation changes lives
### ~~Validation (probably?) saves lives~~

---
# Story
---
<ContentLayout>

## Matchmaker Exchange API

 - Siloed databases of patient data
   - <small>(including DNA variants)</small>
 - Rare and undiagnosed cases
   - <small>(> 10 per country rare)</small>
 - Complex logal and ethical situation
 - Discover and exchange pateint data

</ContentLayout>

<Notes>
  I'm going to walk through what it might have been like to create a JSON Schema for this API.

  The MME API is a federated search (for similar) and response of potential matches using a patient record.

  Not going to cover the legal, social, or ethical issues. Be assured they were handled properly.

  Today is about the technical.
</Notes>

---
<ContentLayout>

## Matchmaker Exchange API

- Each database holds slightly different data
- Representation of a patient needs to be uniform
- Write specification using words and examples
- Release v1.0!

## Sounds easy, right?

</ContentLayout>

---

<Invert>

# Nope

<img style={{
  maxWidth: '50%'
}} src={mmev1} />

</Invert>

---

# Building a schema

---
<ContentLayout>

## Requirements for queries

- Root object must have a <code>patient</code>
- <code>patient</code> must have either properties <code>genomicFeatures</code> or <code>phenotypicFeatures</code> or both

</ContentLayout>

---

<CodeSurferLayout theme={github}>
<Code
  lang="json"
  code={basicSchemas['001']}
  title="Matchmaker Query Schema"
/>

<Code
  lang="json"
  code={basicSchemas['002']}
/>

<Code
  lang="json"
  code={basicSchemas['003']}
  focus="1:11"
  subtitle="‚ùå Validation seems to do nothing  ü§∑‚Äç‚ôÇÔ∏è"
/>

<Code
  lang="json"
  code={basicSchemas['003']}
  focus="1:11"
  subtitle="This is a schema. A JSON Schema!"
/>

```diff 2,3,5,6 subtitle="These are known keywords"
```

```diff 4 subtitle="This is an unknown keyword. Unknown keywords are ignored."
```

</CodeSurferLayout>

---

<Invert>

# What's a "schema" anyway?

</Invert>

---

<ContentLayout>

# JSON Schema

<ul>
  <li>A vocabulary that allows you to annotate and validate JSON documents.</li>
<Appear>
  <li>An IETF "personal draft" document specification</li>
  <li>JSON!</li>
  <li>Must be a boolean or an object</li>
</Appear>
</ul>

</ContentLayout>

---

<ContentLayout>

# JSON Schema

- This talk covers draft-7. Not draft-4, not draft-8

  <img style={{
    maxWidth: '90%'
  }} src={drafts} />

</ContentLayout>

---

<ContentLayout >

# Key Concepts

**Schema ‚Äúkeywords‚Äù** : Object properties that are applied to the instance<br/><br/>
**Instance** : The JSON document being validated or associated with a Schema<br/><br/>
**Root Schema** : Schema that is the whole JSON document<br/>
**Subschema** : A schema as a value of an object or array<br/><br/><br/>
Keywords fall under one or both of two categories (mostly):<br/><br/>
**Assertions** : produce a boolean result when applied to an instance<br/>
**Annotations** : attach information to an instance for application use<br/><br/>

</ContentLayout>

---

# "`properties`" keyword

<p><code>properties</code> is an object</p>
<p>The values of the object are applied to the instance according to matching objects keys</p>

---

<CodeSurferLayout theme={github}>
<Code
  lang="json"
  code={basicSchemas['003']}
  focus="4"
  subtitle="This is an unknown keyword. Unknown keywords are ignored."
/>

<Code
  lang="json"
  code={basicSchemas['004']}
  subtitle="The value of `patient` is a subschema and is now applied to the same keyed value in the instance"
/>

<Code
  lang="json"
  code={basicSchemas['004']}
  focus="7:10"
  subtitle="Error: The items in `anyOf` must be a Schema"
/>

<Code
  lang="json"
  code={basicSchemas['005']}
  subtitle="Now each item in the array is a Schema"
/>

<Code
  lang="json"
  code={basicSchemas['005']}
  focus="10,15"
  subtitle="Remember, the values of a `properties` object must be Schemas. A Boolean is a valid Schema."
/>

</CodeSurferLayout>

---

# A Boolean can be a schema?

---

<Invert>

# What's a Schema again? (pt 2)

</Invert>

---

<ContentLayout>

### An Object or a Boolean

<div style={{ display: 'flex' }}>
  <div style={{ margin: '0em 1em' }}>

#### Always passes validation

  <code>{"{}"}</code>

  <p>An empty object</p>

  <code lang="json">true</code>

  <p>a `true` boolean value</p>

  </div>
  <div style={{ margin: '0em 1em' }}>

#### Always fails validation

  <code lang="json">{'{ "not": {} }'}</code>

  <p>`not` keyword: inverts the assertion</p>

  <code lang="json">false</code>

  <p>a `false` boolean value</p>

  </div>

</div>

</ContentLayout>

---

### Does it work?

<CodeSurferColumnLayout sizes={[1, 1]}>

<Step subtitle="Let's add the subschemas">

  <Code
    lang="json"
    title="Schema"
    code={basicSchemas['006']}
  />

  ```json title="Instance"
    {
      "patient": {
      }
    }
  ```

</Step>

<Step subtitle="‚úÖ This instance validates OK...">

  <Code
    lang="json"
    code={basicSchemas['007']}
  />

  ```json 1:7
    {
      "patient": {
        "phenotypicFeatures": [
          "long nose"
        ]
      }
    }
  ```

</Step>

<Step subtitle="‚úÖ ...and this one...">

  <Code
    lang="json"
    code={basicSchemas['007']}
    focus="1:24"
  />

  ```json 1:7
    {
      "patient": {
        "genomicFeatures": [
          "1:2323_CA>A"
        ]
      }
    }
  ```

</Step>

<Step subtitle="‚úÖ ...and both?">

  <Code
    lang="json"
    code={basicSchemas['007']}
    focus="1:24"
  />

  ```json 1:10
    {
      "patient": {
        "phenotypicFeatures": [
          "long nose"
        ],
        "genomicFeatures": [
          "1:2323_CA>A"
        ]
      }
    }
  ```

</Step>

<Step subtitle="ü§î How about something invalid?... ‚úÖ">

  <Code
    lang="json"
    code={basicSchemas['007']}
    focus="1:24"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="üòï But didn't I define that should be an array?">

  <Code
    lang="json"
    code={basicSchemas['007']}
    focus="10:12"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>


</CodeSurferColumnLayout>

---

<Invert>

# anyOf what?

</Invert>

---

<ContentLayout >

# (More) Key Concepts

**Applicator keywords**: Determin how subschemas are applied to an instance location.

Include, but not limited to...

<p><code>oneOf</code>, <code>allOf</code>, and <code>anyOf</code></p>

</ContentLayout>

---

<ContentLayout >

# <code>*Of</code> applicators

<p>The value of <code>*Of</code> keywords must be an array of Schemas.</p>

The result of applying a schema to an instance is includes an assertion of validity.

The resulting assertion is a combination of the assertion results.

<p>For example, <code>oneOf</code> requires that ONLY one of the Schemas in the array is valid.</p>

</ContentLayout>

---

### Why doesn't it work?

<CodeSurferColumnLayout sizes={[1, 1]}>

<Step subtitle="üòï But didn't I define that should be an array?">

  <Code
    lang="json"
    code={basicSchemas['007']}
    focus="10:12"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="üí° This is a schema. Schemas can be booleans...">

  <Code
    lang="json"
    code={basicSchemas['007']}
    focus="7:13"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="üßê ... I can replace schemas with boolean values to debug the schema">

  <Code
    lang="json"
    code={basicSchemas['008']}
    focus="7:13"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="Validation still passes? What gives? (second subschema doesn't define `phenotypicFeatures`">

  <Code
    lang="json"
    code={basicSchemas['008']}
    focus="6:16"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="In the Schema, `properties.patient.anyOf[1]` ONLY expresses a constraint on a property called `phenotypicFeatures`. Nothing else.">

  <Code
    lang="json"
    code={basicSchemas['008']}
    focus="6:16"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="OK. Let's dissallow additional properties in that subschema.">

  <Code
    lang="json"
    code={basicSchemas['009']}
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="... and add back the other subschema...">

  <Code
    lang="json"
    code={basicSchemas['010']}
    focus="7:16"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="... ‚ùå YES! Validation fails, as expected">

  <Code
    lang="json"
    code={basicSchemas['010']}
    focus="1:27"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

</CodeSurferColumnLayout>

---

# We fixed it!

## Almost


---

<CodeSurferColumnLayout>

<Step subtitle="What happens if we... remove the properties of `patient`?">

  <Code
    lang="json"
    code={basicSchemas['010']}
    focus="1:27"
  />

  ```json 1:5
    {
      "patient": {
        "phenotypicFeatures": "long nose"
      }
    }
  ```

</Step>

<Step subtitle="... ‚úÖ üò† STILL missing something!">

  <Code
    lang="json"
    code={basicSchemas['010']}
    focus="1:27"
  />

  ```json 1:5
    {
      "patient": {

      }
    }
  ```

</Step>

<Step subtitle="Keys of `properties` are not expressing a requirement they exist!">

  <Code
    lang="json"
    code={basicSchemas['010']}
    focus="8:13"
  />

  ```json 1:5
    {
      "patient": {

      }
    }
  ```

</Step>

<Step subtitle="Need to use `required` to require them">

  <Code
    lang="json"
    code={basicSchemas['011']}
  />

  ```json 1:5
    {
      "patient": {

      }
    }
  ```

</Step>

<Step subtitle="‚ùå Validation now fails as expected!">

  <Code
    lang="json"
    code={basicSchemas['011']}
    focus="1:31"
  />

  ```json 1:5
    {
      "patient": {

      }
    }
  ```

</Step>


</CodeSurferColumnLayout>

---

# What did we learn?

- Some keywords have values that are a JSON Schema (a subschema)
- <code>*Of</code> keywords are applicators that take an array of subschemas
- You can set the value of a subschema to a boolean <code>false</code> to check the validation path is as you expect
